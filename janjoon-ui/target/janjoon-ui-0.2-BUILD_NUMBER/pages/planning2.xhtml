<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">
	
<ui:composition template="../templates/layout.xhtml">
	<ui:define name="content"><center>
		<p:tabMenu activeIndex="0" name="content">
			<ui:include src="/templates/menu.xhtml" />
		</p:tabMenu>
		<br/><br/><br/><br/>
		<div style="width:600px">
			<h:form>
			<div id="ndo" style="position:absolute;right:5px;top:5px;width:378px;padding:5px;background-color: #FFF5E6; border:1px solid #F9A22F; font-size:12px">
			  This Gantt can be used in a complete project management solution - imports your Gantt and more - <a href="http://twproject.com" target="_blank">Teamwork: give it a try</a>.
		</div>
		<div id="workSpace" style="padding:0px; overflow-y:auto; overflow-x:hidden;border:1px solid #e5e5e5;position:relative;margin:0 5px"></div>

		<div id="taZone" style="display:none;">
			<textarea rows="8" cols="150" id="ta">
				{"tasks":[
				{"id":-1,"name":"Gantt editor","code":"","level":0,"status":"STATUS_ACTIVE","start":1346623200000,"duration":16,"end":1348523999999,"startIsMilestone":true,"endIsMilestone":false,"assigs":[]},
				{"id":-2,"name":"coding","code":"","level":1,"status":"STATUS_ACTIVE","start":1346623200000,"duration":10,"end":1347659999999,"startIsMilestone":false,"endIsMilestone":false,"assigs":[],"description":"","progress":0},
				{"id":-3,"name":"gant part","code":"","level":2,"status":"STATUS_ACTIVE","start":1346623200000,"duration":2,"end":1346795999999,"startIsMilestone":false,"endIsMilestone":false,"assigs":[],"depends":""},
				{"id":-4,"name":"editor part","code":"","level":2,"status":"STATUS_SUSPENDED","start":1346796000000,"duration":4,"end":1347314399999,"startIsMilestone":false,"endIsMilestone":false,"assigs":[],"depends":"3"},
				{"id":-5,"name":"testing","code":"","level":1,"status":"STATUS_SUSPENDED","start":1347832800000,"duration":6,"end":1348523999999,"startIsMilestone":false,"endIsMilestone":false,"assigs":[],"depends":"2:5","description":"","progress":0},
				{"id":-6,"name":"test on safari","code":"","level":2,"status":"STATUS_SUSPENDED","start":1347832800000,"duration":2,"end":1348005599999,"startIsMilestone":false,"endIsMilestone":false,"assigs":[],"depends":""},
				{"id":-7,"name":"test on ie","code":"","level":2,"status":"STATUS_SUSPENDED","start":1348005600000,"duration":3,"end":1348264799999,"startIsMilestone":false,"endIsMilestone":false,"assigs":[],"depends":"6"},
				{"id":-8,"name":"test on chrome","code":"","level":2,"status":"STATUS_SUSPENDED","start":1348005600000,"duration":2,"end":1348178399999,"startIsMilestone":false,"endIsMilestone":false,"assigs":[],"depends":"6"}
				],"selectedRow":0,"deletedTaskIds":[],"canWrite":true,"canWriteOnParent":true }
			</textarea>
			<button onclick="loadGanttFromServer();">load</button>
		</div>

<style>
	  .resEdit {
		padding: 15px;
	  }

	  .resLine {
		width: 95%;
		padding: 3px;
		margin: 5px;
		border: 1px solid #d0d0d0;
	  }

	  body {
		overflow: hidden;
	  }
	</style>

	<form id="gimmeBack" style="display:none;" action="../gimmeBack.jsp" method="post" target="_blank">
		<input type="hidden" name="prj" id="gimBaPrj"/>
	</form>

	<script type="text/javascript">
//<![CDATA[ 

var ge;  //this is the hugly but very friendly global var for the gantt editor
$(function() {

  //load templates
  $("#ganttemplates").loadTemplates();

  // here starts gantt initialization
  ge = new GanttMaster();
  var workSpace = $("#workSpace");
  workSpace.css({width:$(window).width() - 20,height:$(window).height() - 100});
  ge.init(workSpace);

  //inject some buttons (for this demo only)
  $(".ganttButtonBar div").append("<button onclick='clearGantt();' class='button'>clear</button>")
		  .append("		")
		  .append("<button onclick='openResourceEditor();' class='button'>edit resources</button>")
		  .append("<button onclick='getFile();' class='button'>export</button>");
  $(".ganttButtonBar h1").html("<img src='twGanttSmall.png'>");
  $(".ganttButtonBar div").addClass('buttons');
  //overwrite with localized ones
  loadI18n();

  //simulate a data load from a server.
  loadGanttFromServer();


  //fill default Teamwork roles if any
  if (!ge.roles || ge.roles.length == 0) {
	setRoles();
  }

  //fill default Resources roles if any
  if (!ge.resources || ge.resources.length == 0) {
	setResource();
  }



});


function loadGanttFromServer(taskId, callback) {

  //this is a simulation: load data from the local storage if you have already played with the demo or a textarea with starting demo data
  loadFromLocalStorage();


}


function saveGanttOnServer() {

  //this is a simulation: save data to the local storage or to the textarea
  saveInLocalStorage();

}


//-------------------------------------------  Create some demo data ------------------------------------------------------
function setRoles() {
  ge.roles = [
	{
	  id:"tmp_1",
	  name:"Project Manager"
	},
	{
	  id:"tmp_2",
	  name:"Worker"
	},
	{
	  id:"tmp_3",
	  name:"Stakeholder/Customer"
	}
  ];
}

function setResource() {
  var res = [];
  res.push({id:"tmp_0",name:"Resource 0"});
  res.push({id:"tmp_1",name:"Resource 1"});
  res.push({id:"tmp_2",name:"Resource 2"});
  res.push({id:"tmp_3",name:"Resource 3"});
  res.push({id:"tmp_4",name:"Resource 4"});
  res.push({id:"tmp_5",name:"Resource 5"});
  res.push({id:"tmp_6",name:"Resource 6"});
  res.push({id:"tmp_7",name:"Resource 7"});
  res.push({id:"tmp_8",name:"Resource 8"});
  res.push({id:"tmp_9",name:"Resource 9"});
  ge.resources = res;
}



function clearGantt() {
  ge.reset();
}

function loadI18n() {
  GanttMaster.messages = {
	"CHANGE_OUT_OF_SCOPE":"NO_RIGHTS_FOR_UPDATE_PARENTS_OUT_OF_EDITOR_SCOPE",
	"START_IS_MILESTONE":"START_IS_MILESTONE",
	"END_IS_MILESTONE":"END_IS_MILESTONE",
	"TASK_HAS_CONSTRAINTS":"TASK_HAS_CONSTRAINTS",
	"GANTT_ERROR_DEPENDS_ON_OPEN_TASK":"GANTT_ERROR_DEPENDS_ON_OPEN_TASK",
	"GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK":"GANTT_ERROR_DESCENDANT_OF_CLOSED_TASK",
	"TASK_HAS_EXTERNAL_DEPS":"TASK_HAS_EXTERNAL_DEPS",
	"GANNT_ERROR_LOADING_DATA_TASK_REMOVED":"GANNT_ERROR_LOADING_DATA_TASK_REMOVED",
	"ERROR_SETTING_DATES":"ERROR_SETTING_DATES",
	"CIRCULAR_REFERENCE":"CIRCULAR_REFERENCE",
	"CANNOT_DEPENDS_ON_ANCESTORS":"CANNOT_DEPENDS_ON_ANCESTORS",
	"CANNOT_DEPENDS_ON_DESCENDANTS":"CANNOT_DEPENDS_ON_DESCENDANTS",
	"INVALID_DATE_FORMAT":"INVALID_DATE_FORMAT",
	"TASK_MOVE_INCONSISTENT_LEVEL":"TASK_MOVE_INCONSISTENT_LEVEL",

	"GANT_QUARTER_SHORT":"trim.",
	"GANT_SEMESTER_SHORT":"sem."
  };
}


//-------------------------------------------  Open a black popup for managing resources. This is only an axample of implementation (usually resources come from server) ------------------------------------------------------
function openResourceEditor() {
  var editor = $("<div>");
  editor.append("<h2>Resource editor</h2>");
  editor.addClass("resEdit");

  for (var i in ge.resources) {
	var res = ge.resources[i];
	var inp = $("<input type='text'>").attr("pos", i).addClass("resLine").val(res.name);
	editor.append(inp).append("<br>");
  }

  var sv = $("<div>save</div>").css("float", "right").addClass("button").click(function() {
	$(this).closest(".resEdit").find("input").each(function() {
	  var el = $(this);
	  var pos = el.attr("pos");
	  ge.resources[pos].name = el.val();
	});
	ge.editor.redraw();
	closeBlackPopup();
  });
  editor.append(sv);

  var ndo = createBlackPage(800, 500).append(editor);
}

//-------------------------------------------  Get project file as JSON (used for migrate project from gantt to Teamwork) ------------------------------------------------------
function getFile() {
  $("#gimBaPrj").val(JSON.stringify(ge.saveProject()));
  $("#gimmeBack").submit();
  $("#gimBaPrj").val("");

}


//-------------------------------------------  LOCAL STORAGE MANAGEMENT (for this demo only) ------------------------------------------------------
Storage.prototype.setObject = function(key, value) {
  this.setItem(key, JSON.stringify(value));
};


Storage.prototype.getObject = function(key) {
  var stuff = (this.getItem(key)) && (JSON.parse(this.getItem(key)));
  return this.getItem(key)
};


function loadFromLocalStorage() {
  var ret;
  if (localStorage) {
	if (localStorage.getObject("teamworkGantDemo")) {
	  ret = localStorage.getObject("teamworkGantDemo");
	}
  } else {
	$("#taZone").show();
  }
  if (!ret || !ret.tasks || ret.tasks.length == 0)
	ret = JSON.parse($("#ta").val());
  ge.loadProject(ret);
  ge.checkpoint(); //empty the undo stack
}


function saveInLocalStorage() {
  var prj = ge.saveProject();
  if (localStorage) {
	localStorage.setObject("teamworkGantDemo", prj);
  } else {
	$("#ta").val(JSON.stringify(prj));
  }
}

// ]]>

</script>

<div id="gantEditorTemplates" style="display:none;">
	<div class="__template__" type="GANTBUTTONS"></div>
	<div class="__template__" type="TASKSEDITHEAD"></div>
	<div class="__template__" type="TASKROW"></div>
	<div class="__template__" type="TASKEMPTYROW"></div>
	<div class="__template__" type="TASKBAR"></div>
	<div class="__template__" type="CHANGE_STATUS"></div>
	<div class="__template__" type="TASK_EDITOR"></div>
	<div class="__template__" type="ASSIGNMENT_ROW"></div>
</div>

<script type="text/javascript">
//<![CDATA[ 
  $.JST.loadDecorator("ASSIGNMENT_ROW", function(assigTr, taskAssig) {

	var resEl = assigTr.find("[name=resourceId]");
	for (var i in taskAssig.task.master.resources) {
	  var res = taskAssig.task.master.resources[i];
	  var opt = $("<option>");
	  opt.val(res.id).html(res.name);
	  if (taskAssig.assig.resourceId == res.id)
		opt.attr("selected", "true");
	  resEl.append(opt);
	}


	var roleEl = assigTr.find("[name=roleId]");
	for (var i in taskAssig.task.master.roles) {
	  var role = taskAssig.task.master.roles[i];
	  var optr = $("<option>");
	  optr.val(role.id).html(role.name);
	  if (taskAssig.assig.roleId == role.id)
		optr.attr("selected", "true");
	  roleEl.append(optr);
	}

	if (taskAssig.task.master.canWrite) {
	  assigTr.find(".delAssig").click(function() {
		var tr = $(this).closest("[assigId]").fadeOut(200, function() {
		  $(this).remove();
		});
	  });
	}


  });
//]]>
</script>
			</h:form>
		</div>
		</center>
	</ui:define>
</ui:composition>
</html>